extends masebook.pug

block title
    - const titleText = space.name ? `Edit Space | ${space.name}` : 'New Space'
    title= titleText

mixin options(default_item)
    each i in ['member', 'moderator', 'administrator', 'owner']
        if (i == default_item)
            option(value=i selected)= i
        else
            option(value=i)= i

mixin permissions(defaults)
    each i in defaults
        - const action  = 'p_' + i.action
        label(for=action)= i.description
        select(id=action, name=action)
            +options(i.default_role_required)

block content
    h1= titleText
    form#space-editor()
        .form-item.block
            label(for='space_name') Name
            input#space_name(type='text', name='name', minlength='1', maxlength='64', required)
        .form-item.block
            label(for='space_desc') Description
            input#space_desc(type='text', name='description', minlength='1', maxlength='256')
        .form-item
            input#space_visible(type='checkbox', name='visible', value='true')
            label(for='space_visible') Visible to non-members
        .form-item
            input#space_show_in_dir(type='checkbox', name='show_in_dir', value='true')
            label(for='space_show_in_dir') Show in Server Directory
        
        fieldset.form-item
            legend Permissions
            +permissions(space.default_permissions)
        
        input.form-item(type='submit', value='submit')
    script.
        const form = document.getElementById('space-editor');
        form.addEventListener('submit', async event => {
            event.preventDefault();
            const data = new FormData(form);

            const reformatted = {
                settings: {},
                permissions: []
            };

            for (const [k,v] of data.entries()) {
                if (k.startsWith('p_')) {
                    reformatted.permissions.push([k.substring(2),v]);
                }
                else {
                    reformatted.settings[k] = v;
                }
            }

            try {
                const fetchOptions = {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json"
                    },
                    body: JSON.stringify(reformatted),
                }
                fetch('/spaces', fetchOptions)
                    .then(res => {
                        if (res.redirected) {
                            window.location.href = res.url;
                        }
                    });
            }
            catch (err) {
                console.log(err.message);
            }
        });